#!/usr/bin/env bash

# TODO: change to snake style

if command -v tmux &>/dev/null && [ -n "$PS1" ] && [[ ! "$TERM" =~ screen ]] && [[ ! "$TERM" =~ tmux ]] && [ -z "$TMUX" ]; then
  tmux attach || tmux new-session && exit
fi

export PATH="$HOME/.gem/ruby/2.7.0/bin:$PATH"
export PATH="$HOME/.local/share/gem/ruby/3.0.0/bin:$PATH"
export PATH="$HOME/gems/bin:$PATH"

export PATH=$PATH:$HOME/dotfiles/bin
export PATH=$PATH:$HOME/.local/bin
export PATH=$PATH:$HOME/bin

export PATH=$PATH:$HOME/.cargo/bin

export PATH=$PATH:/usr/local/go/bin
export PATH=$PATH:$HOME/go/bin

export PATH="$HOME/.npm/bin:$PATH"
export PNPM_HOME="/home/master/.local/share/pnpm"
export PATH="$PNPM_HOME:$PATH"

export GEM_HOME="$HOME/gems"

export RIPGREP_CONFIG_PATH="$HOME/.ripgreprc"

export DENO_INSTALL="$HOME/.deno"
export PATH="$DENO_INSTALL/bin:$PATH"

export VISUAL="nvim"
export EDITOR=$VISUAL
export MANPAGER="nvim +Man!"
export EDITOR="nvim"

export BROWSER="google-chrome-stable"

export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND="fd -t d"

HISTCONTROL=ignoreboth
HISTSIZE=
HISTFILESIZE=
shopt -s histappend
shopt -s checkwinsize

bind "set completion-ignore-case on"

set -o vi

stty time 0

alias bat="bat --theme=GitHub"
alias r="trash"
alias x="chmod +x"
alias q="exit"
alias ":q"="exit"
alias testKeyboardInputCode="sudo showkey"
alias open="xdg-open"
alias googleArtDownload="dezoomify-rs (wl-paste)"
alias kittyListFont="kitty +list-fonts --psnames"
alias createAstro="pnpm create astro@latest"
alias clear="clear -x; (tmuxKillAllUnnameSession &)"
alias killTmuxServer="tmux kill-server"
alias copyFilePath="readlink -f $1 | wl-copy"
alias countItemInCurrentDirectory="fd --type file | wc --lines"
alias editDnfConfig="sudoedit /etc/dnf/dnf.conf"
alias editSudoers="sudoedit /etc/sudoers"
alias reloadFonts="fc-cache --force --verbose"

function editApplicationDesktopFile() {
  CURRENT_DIR=$(pwd)

  cd /usr/share/applications/

  fzfSudoEdit

  cd $CURRENT_DIR
}

alias lazydocker="sudo $HOME/go/bin/lazydocker"
alias startDocker="sudo systemctl start docker"
alias docker="sudo docker"
alias docker-compose="sudo docker-compose"

alias pnpmDev="pnpm dev"
alias pnpmFormat="pnpm format"
alias pnpmBuild="pnpm build"
alias pnpmInstall="pnpm install"
alias pnpmInstallGlobal="pnpm install --global"
alias neofetch="echo 'fuck you'; echo 'use fastfetch'"

alias bluetoothTurnOn="bluetoothctl power on"
alias bluetoothTurnOff="bluetoothctl power off"
alias bluetoothDevices="bluetoothctl devices"

function bluetoothConnectSpeakerPluse4() {
  bluetoothTurnOn
  bluetoothctl connect C1:AC:88:3D:D6:EE
}

function bluetoothDisconnectSpeakerPluse4() {
  bluetoothctl disconnect C1:AC:88:3D:D6:EE
}

function thRestartSpeakerPluse4() {
  bluetoothDisconnectSpeakerPluse4
  bluetoothConnectSpeakerPluse4
}

alias stopMouseless="systemctl --user stop mouseless.service"
alias startMouseless="systemctl --user start mouseless.service"
alias debugMouseless="stopMouseless mouseless --debug"

function reloadMouseless() {
  stopMouseless
  echo 'wait 2s'
  sleep 2
  startMouseless
}

alias ls="exa --icons"
alias ll="exa --all --long --header --icons --git"
alias l="ll"
alias tree="exa --tree --long"

function gitAutoCommit() {

  echo "
  $ git add -A
  $ git commit -m 'auto commit'
  "

  git add -A
  git commit -m 'auto commit'
}
alias aa="gitAutoCommit"

function gitCommitCurrentChange() {
  git add -A
  git commit
}
alias a="gitCommitCurrentChange"

function gitUseLastCommitMessageForCurrentChange() {
  git add -A
  git commit --amend --no-edit
}
alias am="gitUseLastCommitMessageForCurrentChange"

function changeDirectoryTogitRoot() {
  cd $(git rev-parse --show-toplevel)
}
alias cdr="changeDirectoryTogitRoot"

function gitAutoCommitAndPush() {
  gitAutoCommit
  git push
}

alias p="git push"
alias pp="git push -f"
alias s="git status -sb"
alias gitResetHard="git reset --hard"
alias d="git diff --word-diff"

alias ...="cd .. ; cd .. ; ls"
alias ..="cd .. ; ls"
alias doc="cd ~/Documents ; ls"
alias dow="cd ~/Downloads ; ls"
alias tmp="cd /tmp ; ls"

function isGitRepo() {
  git rev-parse HEAD >/dev/null 2>&1
}

function removeJetBrainToolbox() {
  echo "make sure you uninstall all applications installed in Toolbox App"
  echo "Press any key to continue..."
  read -n 1 -r -s

  rm -rf ~/.config/autostart/jetbrains-toolbox.desktop
  killall jetbrains-toolbox
  rm -rf ~/.local/share/JetBrains/Toolbox
  rm -rf ~/.local/share/applications/jetbrains-toolbox.desktop
}

function downloadYoutubeAudio() {
  if [ -z "$1" ]; then
    yt-dlp --extract-audio --continue --add-metadata --embed-thumbnail --audio-format mp3 --audio-quality 0 --metadata-from-title="%(artist)s - %(title)s" "$(wl-paste)"
  else
    yt-dlp --extract-audio --continue --add-metadata --embed-thumbnail --audio-format mp3 --audio-quality 0 --metadata-from-title="%(artist)s - %(title)s" "$1"
  fi
}

function downloadYoutubeVideo() {
  if [ -z "$1" ]; then
    yt-dlp -o "%(title)s.%(ext)s" "$(wl-paste)"
  else
    yt-dlp -o "%(title)s.%(ext)s" "$1"
  fi
}

# # TODO: sync music the real way, can delete music on local
function syncMusic() {
  CURRENT_DIR=$(pwd)

  cd $HOME/Music/

  yt-dlp --download-archive archive.txt --extract-audio --continue --add-metadata --embed-thumbnail --audio-format mp3 --audio-quality 0 --metadata-from-title="%(artist)s - %(title)s" "https://l.thuanowa.com/music-playlist"

  cd $CURRENT_DIR
}

function updateBashPlugin() {
  CURRENT_DIR=$(pwd)

  cd ~/dotfiles/bash/
  cat plugin_url.txt | parallel -j8 curl --remote-name

  cd $CURRENT_DIR
}

function updateNvimLazy() {
  CURRENT_DIR=$(pwd)

  cd $HOME/dotfiles/
  nvim --headless "+Lazy! sync" +qa

  cd $CURRENT_DIR
}

function updateFirefoxTheme() {
  CURRENT_DIR=$(pwd)

  THEME_LOCATION=/home/master/.mozilla/firefox/ilkri3vv.default-release/chrome/

  cd $THEME_LOCATION
  git pull

  cd $CURRENT_DIR
}

function giveMePower() {
  echo "( Â¯ ê’³ Â¯)> Give me power"
  sudo echo "( Â¯ ê’³ Â¯)> ðŸ”¥ðŸ”¥ðŸ”¥"
}

function update() {
  giveMePower

  dnf makecache
  sudo dnf update -y

  pnpm add -g pnpm
  pnpm update -g

  tldr --update

  updateFirefoxTheme

  updateBashPlugin

  # updateNvimLazy
}

function browserSyncStartserver() {
  SERVER_IP=$(hostname -I)
  browser-sync start --server --files . --no-notify --host "$SERVER_IP" --port 9000
}
alias ser="browserSyncStartserver"

function gitCloneRepoInClipboard() {
  url_to_username_repo=$(wl-paste | sed 's/.*m\///g')
  repoName=$(wl-paste | sed 's/.*\///g')
  gh repo clone "$url_to_username_repo"
  cd "$repoName"
}

function fzfEmoji() {
  default() {
    emoji-fzf preview --prepend | fzf | awk '{ print $1 }' | tr -d "\n" | wl-copy
  }

  if hash emoji-fzf 2>/dev/null; then
    default
  else
    pip install emoji-fzf
    default
  fi
}
alias ej="fzfEmoji"

function fzfEditFile() {
  if [ -z "$1" ]; then
    FILE=$(fd --hidden --type file . | fzf --preview 'bat --theme=GitHub --color=always --style=numbers --line-range=:501 {}' &)

    if [ -n "$FILE" ]; then
      nvim "$FILE"
    fi
  else
    nvim "$1"
  fi
}
alias e="fzfEditFile"
alias e.="nvim ."
alias ee="cd $HOME; fzfEditFile"

function fzfSudoEdit() {
  if [ -z "$1" ]; then
    FILE=$(fd --hidden --type file . | fzf --preview 'bat --theme=GitHub --color=always --style=numbers --line-range=:501 {}' &)

    if [ -n "$FILE" ]; then
      sudoedit "$FILE"
    fi
  else
    sudoedit "$1"
  fi
}
alias E="fzfSudoEdit"

function fzfGitWorktreeChangeDir() {
  isGitRepo || return

  local worktrees
  local worktree
  local query
  local sess_arr
  local retval
  worktrees=$(git worktree list | fzf --exit-0 --print-query)
  retval=$?

  IFS=$'\n' read -rd '' -a sess_arr <<<"$worktrees"

  worktree=$(echo ${sess_arr[1]} | awk '{print $1}')
  query=${sess_arr[0]}

  if [ $retval == 0 ]; then
    if [ "$worktree" == "" ]; then
      worktree=$(echo "$query" | awk '{print $1}')
    fi
    cd "$worktree"
    tmux rename-window "$(git branch --show-current)"
  elif [ $retval == 1 ]; then
    DEFAULT_GIT_FOLDER=$(git worktree list | head --lines 1 | awk '{print $1}')

    mkdir $DEFAULT_GIT_FOLDER/.worktrees

    git worktree add $DEFAULT_GIT_FOLDER/.worktrees/"$query"

    cd $DEFAULT_GIT_FOLDER/.worktrees/"$query"

    git branch "$query"
    git checkout "$query"

    tmux rename-window "$(git branch --show-current)"
  fi
}
alias w="fzfGitWorktreeChangeDir"

function fzfGitWorktreeRemove() {
  isGitRepo || return

  WORKTREE=$(git worktree list | fzf | awk '{print $1}')
  DEFAULT_GIT_FOLDER=$(git worktree list | head --lines 1 | awk '{print $1}')

  git worktree remove $WORKTREE --force &>/dev/null
  cd $DEFAULT_GIT_FOLDER
}
alias wr="fzfGitWorktreeRemove"

function fzfOpen() {
  if [ -z "$1" ]; then
    FILE=$(fd --hidden --type file . | fzf --preview 'bat --theme=GitHub --color=always --style=numbers --line-range=:500 {}' &)

    if [ -n "$FILE" ]; then
      xdg-open "$FILE"
    fi
  else
    xdg-open "$1"
  fi
}
alias o="fzfOpen"

function fzfChangeDirectory() {
  DIR=$1

  fzfDir() {
    DIR=$(fd --hidden --type directory . | fzf --preview $'echo {} | tr -d \'()\' | awk \'{printf "%s ",  $2} {print  $1}\' | xargs -r exa --long --all --icons --color=never' &)
    cd "$DIR"
    ls
  }

  if [ -z "$1" ]; then
    if [[ -n $DIR ]]; then
      cd $DIR &>/dev/null
      ERROR=$?

      if [[ ERROR -eq 1 ]]; then
        echo "\"$1\" directory does not exist"
        fzfDir
      fi
    else
      fzfDir
    fi
  else
    mkdir -p "$1"
    cd "$1"
  fi
}
alias c="fzfChangeDirectory"
alias cc="cd $HOME; fzfChangeDirectory"

function fzfRg() {
  rg --color=always --line-number --no-heading --smart-case "${*:-}" |
    fzf --ansi --color "hl:-1:underline,hl+:-1:underline:reverse" --delimiter : --preview 'bat --theme=GitHub --color=always {1} --highlight-line {2}' --bind 'enter:become($EDITOR {1} +{2})'
}
alias j="fzfRg"

function fzfTldr() {
  tldr --list | sed "s/'//g" | sed "s/,//g" | sed "s/ /\n/g" | sed "s/]//g" | sed "s/\[//g" | fzf --preview "tldr {1}"
}

function tl() {
  if [ -z "$1" ]; then
    COMMAND=$(fzfTldr &)
    tldr $COMMAND
  else
    tldr "$1"
  fi
}

function playMusic() {
  CURRENT_DIR=$(pwd)

  cd ~/Music/

  mpv --no-video --loop-playlist --shuffle --term-osd-bar *

  cd $CURRENT_DIR
}
alias m="playMusic"

function fzfMusic() {
  CURRENT_DIR=$(pwd)

  cd ~/Music/

  MUSIC_FILE=$(fd --type file . | fzf)

  mpv "$MUSIC_FILE"

  cd $CURRENT_DIR
}
alias mm="fzfMusic"

function reload() {
  source ~/.bashrc

  tmux source ~/.tmux.conf
}

function hi() {
  update
  fastfetch
}

function tmuxKillAllUnnameSession() {
  tmux ls | awk '{print $1}' | grep -o '[0-9]\+' >/tmp/killAllUnnameTmuxSessionOutput.sh
  sed -i 's/^/tmux kill-session -t /' /tmp/killAllUnnameTmuxSessionOutput.sh
  chmod +x /tmp/killAllUnnameTmuxSessionOutput.sh
  /tmp/killAllUnnameTmuxSessionOutput.sh
}

function copyEditorConfigFile() {
  changeDirectoryTogitRoot
  cp ~/dotfiles/template/skeleton.editorconfig .editorconfig
}

function gitCloneAllRemoteBranch() {
  for branch in $(git branch -a | grep remotes | grep -v HEAD | grep -v master); do
    git branch --track ${branch#remotes/origin/} $branch
  done
}

function gitCloneAllRepoOfUsername() {
  org=$1
  limit=9999

  cd ~/repos/

  repos="$(gh repo list "$org" -L $limit)"

  repoTotal="$(echo "$repos" | wc -l)"
  reposComplete=0

  echo

  echo "$repos" | while read -r repo; do
    repoName="$(echo "$repo" | cut -f1)"
    echo -ne "\r\e[0K[ $reposComplete / $repoTotal ] Cloning $repoName"
    gh repo clone "$repoName" "$repoName" -- -q 2>/dev/null || (
      cd "$repoName"
      gitCloneAllRemoteBranch
    )
    reposComplete=$((reposComplete + 1))
  done

  echo "Finished cloning all repos in $org."
}

function setupFnm() {
  curl -fsSL https://fnm.vercel.app/install | bash
}

function nvimNoLsp() {
  rm -rf ~/.config/nvim
  ln -sf ~/dotfiles/nvim-no-lsp/ ~/.config/nvim
}

function nvimLsp() {
  rm -rf ~/.config/nvim
  ln -sf ~/dotfiles/nvim/ ~/.config/nvim
}

function setupDeno() {
  if hash deno 2>/dev/null; then
    echo "Deno already installed"
  else
    curl -fsSL https://deno.land/x/install/install.sh | sh
  fi
}

function setupPreCommit() {
  pnpm install husky -D

  pnpm pkg set scripts.prepare="husky install"
  pnpm run prepare

  echo "---"
  echo "Example next step:"
  echo 'npx husky add .husky/pre-commit "npm test"'
  echo 'git add .husky/pre-commit'
  echo "---"
}

function removeAllPreCommit() {
  changeDirectoryTogitRoot
  rm -f .git/hooks/*
}

source ~/dotfiles/bash/fzf-bash-completion.sh
bind -x '"\t": fzf_bash_completion'
source ~/dotfiles/bash/completion.bash
source ~/dotfiles/bash/key-bindings.bash

export PATH="/home/master/.local/share/fnm:$PATH"
eval "$(fnm env)"
eval "$(starship init bash)"
eval "$(fnm env --use-on-cd)"
